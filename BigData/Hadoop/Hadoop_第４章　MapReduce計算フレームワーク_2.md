# 分散大規模データ処理システム -- Hadoop-6

# 第４章　MapReduce計算フレームワーク-2/2

　第４章には、主にMapReduceの運行原理に関する紹介をします。

## 第７節　MapReduceの原理分析

　全体のMapReduce流れがMapTaskとReduceTaskに分けておきて紹介を進めます。

### 7.1　MapTask運行仕組み

![img](D:\OneDrive\picture\Typora\BigData\Hadoop\a9b2a382aae117feefb7706a65771940.png)

**Read階段**

- まず、目標ファイルを読み込む前にローカルでブロック（block）に切り分けて各節点に割り当てます。一般的には128MB固定長に従って分割をし、特別のルールがありません。
- データを読み込む時にgetSplits() メソッドを使用してブロックを切片（splits）に切り分けます。それは理論的な切り分け、デフォルト場合でsplitsの大小は128MBで、ブロックのデフォルト大小と同じです。即ち、デフォルト場合でsplitとblock関係が一対一です。あと、splitsの数量に応じて次の階段に同様なMapTask数を起動されてあります。
- InputFormatクラスを継承するFileInputFormatが、getSplits()メソッドを実装してファイルの切り分けをします。この切り分けは論理的（ロジック）で、物理的な切り分けではありません。

![image-20240923114610607](D:\OneDrive\picture\Typora\BigData\Hadoop\image-20240923114610607.png)

- 切り分けされたのsplit情報、実行するコードを含むjarファイル、そしてジョブ（Job）実行に必要な設定情報（XML設定ファイルなど）を作成します。この一連の情報がまとめられ、YARNに提出されます。
- YARNは、この提出されたジョブに対して必要なリソース（メモリ、CPUなど）を割り当ててジョブを実行します。YARNはまず MrAppMaster（MapReduce Application Master）を起動します。MrAppMasterは、ジョブの周期を管理し、各タスクの実行順序を制定します。後のMapTaskとReduceTask、MapReduceジョブ全体がMrAppMasterの制御で完成されます。

**Map階段**

- Map階段に実行するロジックは書き直されたのmap()メソッドです。
- 入力の[key/value]値が分別ドキュメントの行数keyと当の行の文字です。出力の[key/value]値が一つ単語textとその単語の計数1です。入力key/value値を新しいkey/value値に転換する過程です。

![image-20241014162847885](D:\OneDrive\picture\Typora\BigData\Hadoop\image-20241014162847885.png)

- mapの処理が完了した後、mapの各結果は`context.write`を通じてデータが収集されます。この収集（collect）過程では、最初に分区処理が行われ、デフォルトではHashPartitionerが使用されます。

**Collect階段**

- mapの処理が完了した後、mapの各結果は`context.write()`を通してデータが収集されます。それらのデータをキャッシュに一時的に格納します。
- その一時的なキャッシュが環形キャッシュと呼ばれます。本質は配列で、key/valueペアとそのペアに対応する索引がそれぞれ格納されています。図中の2つの半円形矢印記号みたいものです。
- 環形キャッシュは、デフォルト100Mサイズの制御があります。データを書き込む時に、一定の占有率（80%）に達したらこの部分がロックされて書き込みません。新しいプロセスがデータをキャッシュから取り出して別の所に転送します。その同時に書き込むプロセスが続きます。ただ、配列の末尾から逆方向に残りの20Mキャッシュに書き込みます。一旦80%閾値に達したら上記の過程を繰り返して先頭から書き込みます。
- 環形キャッシュが上述流れを抽象化にする表示であり、新しいデータの追加と古いデータの削除が同時に行われるため効率的になれます。

**Spill階段**

- Spill実は上記の環形キャッシュから書き出す流れです。環形キャッシュの80%閾値までになって80Mデータをロックして単独のプロセスを起動します。データを取り出して動きを指します。
- Spill溢出の過程は80MB内容を索引

> spillが漢字で表せば「溢出」にでき、或いは「溢写」と書いて理解しやすい。

**Merge階段**

