# 分散型協調サービスフレームワーク -- Zookeeper-5

## 第５章　Zookeeperの内部原理

### 第１節　Leaderの選挙機構

**選挙機構**

- 半数以上の機器が稼働していれば、クラスタは利用可能です。従って、ZooKeeperは奇数台のサーバーで設定するのが適している。
- ZooKeeperの配置ファイルにはMasterやSlaveを指定する項目はないが、実際にはLeaderとFollowerという役割があります。ZooKeeperは内部の選挙機構によってLeader節点が選ばれ、他の節点はFollowerとなる。

**初めて起動**

　　仮に、IDが1から5までの5台のサーバーで構成されたZooKeeperクラスターがあり、これらのサーバーは全て最新の起動であり、過去のデータは持ってないと仮定する。![image-20231023163347227](D:\OneDrive\图片\Typora\image-20231023163347227.png)

1. Server1が起動し、この時点ではServerのID最大の自分に投票してあげる。従って、Server1から発信されるメッセージには応答のサーバーがない。そのため、Server1の選挙の状態は常にLOOKING（リーダーの選出を待機中）の状態です。
2. Server2が起動し、同じに自分に投票してあげる。後で、最初に起動したServer1と投票結果を通信し、両者がお互いに選挙結果を交換することが行う。最初起動する場合はどちらも過去のデータがないので、ServerのIDが大きいServer2が２票で勝利する。ただし、半数以上のサーバーが同意しなかったため（この例では半数以上が3台）、Server1と2は引き続きLOOKINGの状態を維持する。
3. Server3が起動する。前述の理論に基づいて半分以上台数の規則が満たし、Server3はServer1、2、3の中で最大のIDを持つため、3票を取得したServer3が順調にLeaderとなる。
4. Server4が起動します。前述の分析に基づいて、理論的にはServer4が最大のIDを持つはずですが、既にServer3を半数以上の投票で選出していたため、Server4はFollowerとして運行することになる。
5. Server5が起動する。Server4と同様にFollower役を担当する。

**初めて起動ではない**

　　半数以上のサーバーが稼働している状態を前提として、最大のトランザクションID（cZxid）を持つサーバーをLeaderに選挙してある。もしLeaderサーバーが故障などの原因で運行しなくなった場合、さっき言った規則に沿って改めて選挙を行う。Follower故障に対して残るサーバーが稼働し続き、特別な変更がない。故障サーバーが正常に復旧し、Leaderから最新のバックアップを取得して他のサーバーと一致するになる。

### 第２節　ZAB協議

　　ZAB（Zookeeper Atomic Broadcast）は崩壊の回復を支持するの原子放送協議です。別の言い方は、ZooKeeperクラスタ内の各サーバー間のデータ整合性を維持するため設計されたの稼働規則という解釈が理解しやすいと思う。ZAB協議が各サーバー間に稼働の流れを説明でき、主にLeader/Follower主従関係の架構を通じてクラスタ全体の整合性を実現してくる。

　　ZAB協議を紹介する前にZookeeperの稼働流れが説明しておく。

![image-20231027144653558](D:\OneDrive\图片\Typora\image-20231027144653558.png)

　　先ず、トランザクション請求（write request）の処理について、Leaderが唯一の担当者となる。どの節点であってもトランザクション請求を受信したら、それをLeader節点に転送して統一に処理する。Leaderが単一の主プロセスで請求の内容に応じてデータを変更操作を順次行う。サーバーのデータの状態が変更されると、トランザクション提案（Proposal）を作成し、且つこの提案を代表するの全局の唯一の変更序列号トランザクションID（cZxid）である。その後、半数以上のサーバーがLeaderの請求を応答すること満足するなら、トランザクション提案の形式で他の節点に分配し、各サーバーが最新の変更序列を保証できてくる。その分配の過程が放送と呼ばれ、各Followerが購読者としてLeaderからメッセージを受信する。

　　次に、普通の読み込み請求（read request）について、請求を受信した節点が自身の検査結果を直接返し、Leaderに報告するなど請求が必要ない。

**ZAB協議核心**

　　ZAB協議は、各Leaderが3つの段階（発見、同期、放送）を経る必要がある。

**発見（Discovery）**： ZooKeeperクラスターは必ず1つのLeaderプロセスを選出する必要がある。同時に、LeaderはFollowerの利用可能な節点リストを維持する。

**同期（Synchronization）**： Leaderは、自身のデータをFollowerと同期させる責任を持ち、複数のバックアップを保存する必要がある。Followerに隊列の未処理の請求を完了した後、受信の情報を本地のログに書き込む。

**放送（Broadcast）**： Leaderは、新しいトランザクション提案があれば、これを全てのFollowerに通知して放送する責任がある。



**ZAB協議内容**